<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدول التمارين الاحترافي</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            vertical-align: top;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }

        /* تنسيق المجموعة الرئيسية لتمارين */
        .main-exercise-group {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #e9f5ff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #007bff;
        }

        .group-title {
            font-weight: bold;
            color: #0056b3;
            font-size: 1.1em;
            flex-grow: 1;
            text-align: right;
            position: relative; /* Needed for placeholder */
        }

        .group-title:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
            cursor: text;
        }
        .group-title:focus:before {
            content: none;
        }

        /* تنسيق أقسام التمارين الفرعية داخل المجموعة الرئيسية */
        .exercise-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* تصميم كل تمرين فردي داخل القسم الفرعي */
        .exercise-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border: 1px solid #cceeff;
            border-radius: 4px;
            background-color: #ffffff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .editable {
            border: 1px solid #ccc;
            padding: 6px;
            min-height: 20px;
            flex-grow: 1;
            outline: none;
            border-radius: 3px;
            background-color: #fff;
            font-size: 0.9em;
            text-align: right;
            box-sizing: border-box; /* Include padding in element's total width and height */
            position: relative; /* Needed for placeholder */
        }
        
        .editable:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
            cursor: text;
        }
        .editable:focus:before {
            content: none;
        }
        
        .editable[data-placeholder="اسم المجموعة"] {
            flex-basis: 70%;
            min-width: 150px;
        }
        .editable[data-placeholder="اسم التمرين"] {
            flex-basis: 30%;
            min-width: 100px;
        }
        .editable[data-placeholder="المجموعات"],
        .editable[data-placeholder="العدات"],
        .editable[data-placeholder="الوقت"],
        .editable[data-placeholder="الوزن"] {
            flex-basis: 15%;
            min-width: 60px;
        }
        .exercise-image-container {
            flex-basis: 80px; /* fixed width for image */
            min-width: 80px;
            height: 80px;
            background-color: #eee;
            border: 1px dashed #bbb;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .exercise-image-container img, .exercise-image-container video, .exercise-image-container iframe {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: cover;
        }
        .exercise-image-container .placeholder-text {
            color: #777;
            font-size: 0.7em;
            text-align: center;
            padding: 5px;
        }
        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            display: none; /* Hidden by default */
        }
        .exercise-image-container:hover .remove-image-btn {
            display: block;
        }
        .exercise-image-container.has-media .placeholder-text {
            display: none;
        }

        .add-btn, .remove-btn, .add-group-btn, .remove-group-btn, .action-button, #toggleWeightsColumn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85em;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            margin: 5px;
        }
        .remove-btn, .remove-group-btn {
            background-color: #f44336;
        }
        .add-btn:hover {
            background-color: #0b7dda;
        }
        .remove-btn:hover {
            background-color: #da190b;
        }
        .add-group-btn {
            background-color: #007bff;
        }
        .add-group-btn:hover {
            background-color: #0056b3;
        }
        .remove-group-btn:hover {
            background-color: #c82333;
        }
        
        .controls {
            margin-top: 10px;
            text-align: center;
        }
        .group-controls {
            display: flex;
            gap: 5px;
        }

        /* Global action buttons container */
        .global-actions {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .global-actions .action-button {
            padding: 10px 20px;
            font-size: 1em;
            margin: 0;
        }
        
        /* Player Info Section */
        .player-info-section {
            background-color: #e0f2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            border: 1px solid #b3e5fc;
        }
        .player-info-section label {
            font-weight: bold;
            color: #01579b;
            display: block;
            margin-bottom: 5px;
        }
        .player-info-section input[type="text"],
        .player-info-section input[type="number"] {
            border: 1px solid #a7d9f0;
            padding: 8px;
            border-radius: 4px;
            width: 200px;
            box-sizing: border-box;
            background-color: #ffffff;
        }
        /* Static text for player info in print mode */
        .player-info-section .static-text {
            font-weight: bold;
            color: #333;
            display: none;
            padding: 8px;
            border-bottom: 1px dotted #ccc;
            width: 200px;
        }
        /* Grouping for level and duration */
        .level-duration-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .level-duration-group div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .level-duration-group label {
            flex-shrink: 0;
            width: 150px;
        }

        /* Levels display in table headers */
        .level-display {
            font-size: 0.9em;
            font-weight: normal;
            display: block;
            margin-top: 5px;
            color: #f0f0f0;
        }

        /* Styles for PDF export (hidden by default) - Not strictly needed now as we use @media print */
        .pdf-export-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .pdf-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .pdf-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .pdf-preview-header h2 {
            margin: 0;
            color: #333;
        }
        .pdf-preview-actions {
            display: flex;
            gap: 10px;
        }
        .pdf-close-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
        }
        .pdf-close-btn:hover {
            background-color: #d32f2f;
        }
        .pdf-action-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .pdf-action-btn:hover {
            background-color: #45a049;
        }
        #previewContent {
            flex-grow: 1;
            overflow: auto;
        }
        /* Important for PDF: the content itself needs to be styled for print */
        #previewContent .workout-table-for-print {
            font-size: 10pt;
            border-collapse: collapse;
            width: 100%;
            box-shadow: none;
            border: 1px solid #333;
            background-color: #fff;
        }
        #previewContent .workout-table-for-print th,
        #previewContent .workout-table-for-print td {
            border: 1px solid #888;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            background-color: #fff;
        }
        #previewContent .workout-table-for-print th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        #previewContent .workout-table-for-print .player-info-section {
            display: flex;
            flex-direction: column;
            border: none;
            background: none;
            box-shadow: none;
            margin-bottom: 15px;
            font-size: 11pt;
            padding: 0;
            gap: 0;
        }
        #previewContent .workout-table-for-print .player-info-section div {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            line-height: 1.2;
        }
        #previewContent .workout-table-for-print .player-info-section label {
            margin-bottom: 0;
            margin-left: 10px;
            flex-basis: 120px;
            text-align: left;
            color: #333;
        }
        #previewContent .workout-table-for-print .player-info-section .static-text {
            display: block !important;
            font-weight: normal;
            color: #333;
            border-bottom: 1px dotted #999;
            padding: 0 5px;
            flex-grow: 1;
            width: auto;
        }
        #previewContent .workout-table-for-print .main-exercise-group {
            border-color: #a0a0a0;
            background-color: #f8f8f8;
            box-shadow: none;
            margin-bottom: 10px;
        }
        #previewContent .workout-table-for-print .group-header {
            border-bottom: 1px dashed #a0a0a0;
        }
        #previewContent .workout-table-for-print .group-title {
            color: #333;
            font-size: 1em;
        }
        #previewContent .workout-table-for-print .exercise-item {
            border-color: #d0d0d0;
            background-color: #ffffff;
            box-shadow: none;
        }
        #previewContent .workout-table-for-print .exercise-image-container {
            display: flex !important;
            border: 1px solid #ccc;
            background: #eee;
            width: 60px;
            height: 60px;
            min-width: 60px;
            min-height: 60px;
        }
        #previewContent .workout-table-for-print .exercise-image-container img,
        #previewContent .workout-table-for-print .exercise-image-container video,
        #previewContent .workout-table-for-print .exercise-image-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #previewContent .workout-table-for-print .level-display {
            color: #333;
        }
        /* Hide interactive elements in preview */
        #previewContent .workout-table-for-print .controls,
        #previewContent .workout-table-for-print .editable,
        #previewContent .workout-table-for-print .add-btn,
        #previewContent .workout-table-for-print .remove-btn,
        #previewContent .workout-table-for-print .add-group-btn,
        #previewContent .workout-table-for-print .remove-group-btn,
        #previewContent .workout-table-for-print .exercise-image-container .placeholder-text,
        #previewContent .workout-table-for-print .remove-image-btn,
        #previewContent .workout-table-for-print .group-controls,
        #previewContent .workout-table-for-print .player-info-section input,
        #previewContent .workout-table-for-print .player-info-section select {
            display: none !important;
        }

        /* --- New styles for optional columns --- */
        .optional-weights-column {
            display: table-cell;
        }
        /* Hide the column content when 'hidden' class is applied to td/th */
        .optional-weights-column.hidden {
            display: none !important;
        }


        /* Print Specific Styles - These apply when window.print() is called */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: none;
                font-size: 10pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Hide all interactive elements and overlay */
            .global-actions, .controls, .editable, .add-btn, .remove-btn, .add-group-btn, .remove-group-btn,
            .exercise-image-container .placeholder-text, .remove-image-btn, .group-controls,
            .player-info-section input, .player-info-section select,
            .pdf-export-overlay,
            #toggleWeightsColumn,
            #traineeProgressSection, /* Hide trainee progress section in print */
            #traineeActions,
            #traineeMonthSelector,
            #copyTraineeLinkBtn,
            #bmiTrackerSection input, #bmiTrackerSection button, #addWeightEntryBtn, #bmiEntryForm{ /* Hide specific trainee elements from print */
                display: none !important; 
            }
            table {
                box-shadow: none;
                border: 1px solid #333;
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            th, td {
                border: 1px solid #888;
                padding: 8px;
            }
            .player-info-section {
                display: flex !important;
                flex-direction: column;
                border: none;
                background: none;
                box-shadow: none;
                margin-bottom: 15px;
                font-size: 11pt;
                padding: 0;
                gap: 0;
            }
            .player-info-section > div {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
                line-height: 1.2;
            }
            .player-info-section label {
                margin-bottom: 0;
                margin-left: 10px;
                flex-basis: 120px;
                text-align: left;
            }
            .player-info-section .level-duration-group div {
                display: flex;
                align-items: center;
                gap: 5px;
            }
            .player-info-section .level-duration-group input {
                display: none !important;
            }
            .player-info-section .static-text {
                display: block !important;
                font-weight: normal;
                color: #333;
                border-bottom: 1px dotted #999;
                padding: 0 5px;
                flex-grow: 1;
                width: auto;
            }
            .main-exercise-group {
                border-color: #a0a0a0;
                background-color: #f8f8f8;
                box-shadow: none;
                margin-bottom: 10px;
            }
            .group-header {
                border-bottom: 1px dashed #a0a0a0;
            }
            .group-title {
                color: #333;
                font-size: 1em;
            }
            .exercise-item {
                border-color: #d0d0d0;
                background-color: #ffffff;
                box-shadow: none;
            }
            .exercise-image-container {
                display: flex !important;
                border: 1px solid #ccc;
                background: #eee;
                width: 60px;
                height: 60px;
                min-width: 60px;
                min-height: 60px;
            }
            .exercise-image-container img, .exercise-image-container video, .exercise-image-container iframe {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .level-display {
                color: #333;
            }
            .editable {
                border: none !important;
                padding: 0 !important;
                background-color: transparent !important;
                outline: none !important;
                color: #333 !important;
            }

            .weights-column-header.hidden-for-print,
            .weights-column-data.hidden-for-print {
                display: none !important;
            }
            
            /* Trainee specific styles for print (hide data entry fields, show summaries) */
            .trainee-input-field, .trainee-save-btn {
                display: none !important;
            }
            .trainee-summary-display {
                display: block !important;
                font-weight: bold;
                margin-top: 5px;
            }
            .trainee-month-progress-container {
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 10px;
                background-color: #f9f9f9;
            }
            
            /* BMI Tracker for Print */
            #bmiTrackerSection {
                display: block !important; /* Make sure it's visible */
                background: none;
                border: none;
                padding: 0;
                margin-top: 20px;
            }
            #bmiTrackerSection h2 {
                color: #333;
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
                margin-bottom: 10px;
            }
            #bmiDisplay, #bmiCategory {
                font-size: 1.1em;
                font-weight: bold;
                color: #0056b3;
                margin-bottom: 5px;
            }
            #heightWeightDisplay {
                font-size: 1em;
                color: #555;
                margin-bottom: 10px;
            }
            #bmiHistory {
                margin-top: 15px;
                border-top: 1px solid #eee;
                padding-top: 10px;
            }
            #bmiHistory h3 {
                color: #333;
                margin-bottom: 8px;
            }
            #bmiHistory ul {
                list-style: none;
                padding: 0;
            }
            #bmiHistory li {
                margin-bottom: 5px;
                font-size: 0.95em;
                color: #444;
            }
        }

        /* --- Trainee Mode Specific Styles --- */
        .trainee-mode .editable,
        .trainee-mode .add-btn,
        .trainee-mode .remove-btn,
        .trainee-mode .add-group-btn,
        .trainee-mode .remove-group-btn,
        .trainee-mode .action-button:not(#copyTraineeLinkBtn):not(#exportTraineeData), /* Keep specific trainee buttons */
        .trainee-mode #toggleWeightsColumn,
        .trainee-mode .group-controls,
        .trainee-mode .player-info-section input,
        .trainee-mode .exercise-image-container input[type="file"],
        .trainee-mode .remove-image-btn,
        .trainee-mode .exercise-image-container[onclick] { /* Disable direct image click for trainee mode */
            display: none !important;
        }

        .trainee-mode .player-info-section label {
            width: auto; /* Revert label width for trainee display */
        }
        .trainee-mode .player-info-section .static-text {
            display: block !important;
            font-weight: bold; /* Make static text bold in trainee mode */
            border-bottom: none; /* Remove border in trainee mode static display */
            width: auto;
        }
        .trainee-mode .player-info-section {
            display: block !important;
            text-align: center;
        }
        .trainee-mode .player-info-section div {
            justify-content: center;
            margin-bottom: 5px;
        }
        .trainee-mode .player-info-section label {
            margin-left: 0;
            margin-right: 10px;
            text-align: right;
            display: inline-block;
            min-width: 120px;
        }

        /* Ensure editable content is displayed as static text in trainee mode */
        .trainee-mode .editable {
            border: none !important;
            padding: 0 !important;
            background-color: transparent !important;
            outline: none !important;
            color: #333 !important;
            display: inline-block !important; /* Make it visible again */
            min-height: auto !important;
            position: static !important;
        }
        .trainee-mode .editable:empty:before {
            content: none;
        }
        
        /* Styles for Trainee Progress Section */
        #traineeProgressSection {
            margin-top: 30px;
            background-color: #e6ffe6;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #a8e6a8;
        }
        #traineeProgressSection h2 {
            text-align: center;
            color: #2e8b57;
            margin-bottom: 20px;
        }
        #traineeMonthSelector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #traineeMonthSelector button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        #traineeMonthSelector button:hover {
            background-color: #45a049;
        }
        #currentMonthDisplay {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        .trainee-input-field {
            width: 70px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            font-size: 0.9em;
        }
        .trainee-save-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .trainee-save-btn:hover {
            background-color: #218838;
        }
        .trainee-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0fff0;
            border: 1px solid #d0ffd0;
            border-radius: 5px;
        }
        .trainee-summary h3 {
            color: #2e8b57;
            text-align: center;
            margin-bottom: 10px;
        }
        .trainee-summary div {
            margin-bottom: 5px;
            font-size: 1.1em;
            text-align: right;
            direction: rtl;
        }
        .trainee-summary span {
            font-weight: bold;
            color: #0056b3;
            margin-left: 5px;
        }

        /* BMI Tracker Styles */
        #bmiTrackerSection {
            margin-top: 30px;
            background-color: #e0f7fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #b2ebf2;
            text-align: center;
        }
        #bmiTrackerSection h2 {
            color: #00838f;
            margin-bottom: 15px;
        }
        #bmiEntryForm {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        #bmiEntryForm input {
            padding: 8px;
            border: 1px solid #a7d9f0;
            border-radius: 4px;
            width: 120px;
            box-sizing: border-box;
        }
        #bmiEntryForm label {
            font-weight: bold;
            color: #006064;
        }
        #bmiEntryForm button {
            background-color: #00bcd4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #bmiEntryForm button:hover {
            background-color: #00acc1;
        }
        #bmiDisplayArea {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0faff;
            border: 1px solid #c5e7f1;
            border-radius: 5px;
        }
        #bmiDisplayArea p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #333;
        }
        #bmiDisplay, #bmiCategory {
            font-weight: bold;
            color: #0056b3;
            font-size: 1.2em;
        }
        #bmiHistory {
            margin-top: 20px;
            padding: 15px;
            background-color: #e1f5fe;
            border: 1px solid #81d4fa;
            border-radius: 5px;
            max-height: 200px; /* Limit height for scroll */
            overflow-y: auto;
            text-align: right;
            direction: rtl;
        }
        #bmiHistory h3 {
            color: #01579b;
            margin-bottom: 10px;
            text-align: center;
        }
        #bmiHistory ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #bmiHistory li {
            padding: 8px 0;
            border-bottom: 1px dotted #b3e0ff;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #bmiHistory li:last-child {
            border-bottom: none;
        }
        #bmiHistory .remove-bmi-entry {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 6px;
            font-size: 0.7em;
            cursor: pointer;
        }
        #bmiHistory .remove-bmi-entry:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>

    <h1 style="text-align: center;">جدول التمارين الاحترافي</h1>

    <div class="player-info-section" id="playerInfoSection">
        <div>
            <label for="playerName">اسم اللاعب:</label>
            <input type="text" id="playerName" placeholder="أدخل اسم اللاعب" oninput="updateStaticPlayerInfo()">
            <span class="static-text" id="staticPlayerName"></span>
        </div>
        <div>
            <label for="coachName">اسم المدرب:</label>
            <input type="text" id="coachName" placeholder="أدخل اسم المدرب" oninput="updateStaticPlayerInfo()">
            <span class="static-text" id="staticCoachName"></span>
        </div>
        <div>
            <label for="country">الدولة:</label>
            <input type="text" id="countryInput" placeholder="أدخل اسم الدولة" oninput="updateStaticPlayerInfo()"> <span class="static-text" id="staticCountry"></span>
        </div>
        <div class="level-duration-group">
            <div>
                <label for="calisthenicsOverallLevel">المستوى العام للكاليستنكس:</label>
                <input type="text" id="calisthenicsOverallLevel" placeholder="مثال: مبتدئ، متوسط، متقدم" oninput="updateStaticPlayerInfo()">
                <span class="static-text" id="staticCalisthenicsOverallLevel"></span>
            </div>
            <div>
                <label for="targetLevelMonths">المستوى المطلوب (أشهر):</label>
                <input type="number" id="targetLevelMonths" placeholder="عدد الأشهر" min="0" oninput="updateStaticPlayerInfo()">
                <span class="static-text" id="staticTargetLevelMonths" style="display:none;"></span> </div>
            <div>
                <label for="currentMonthsAchieved">الأشهر المنجزة حالياً:</label>
                <input type="number" id="currentMonthsAchieved" placeholder="عدد الأشهر" min="0" oninput="updateAchievedDuration(); updateStaticPlayerInfo();">
                <span class="static-text" id="staticCurrentMonthsAchieved"></span>
            </div>
        </div>
        <div>
            <label for="heightCm">الطول (سم):</label>
            <input type="number" id="heightCm" placeholder="أدخل الطول بالسم" min="1" oninput="calculateAndDisplayBMI()">
            <span class="static-text" id="staticHeightCm"></span>
        </div>
        <div>
            <label for="currentWeightKg">الوزن الحالي (كجم):</label>
            <input type="number" id="currentWeightKg" placeholder="أدخل الوزن بالكجم" min="1" oninput="calculateAndDisplayBMI()">
            <span class="static-text" id="staticCurrentWeightKg"></span>
        </div>
        <div id="bmiCoachDisplay" style="text-align: center; margin-top: 10px;">
            <p>مؤشر كتلة الجسم (BMI): <span id="bmiValueCoach" style="font-weight: bold; color: #0056b3;">--</span></p>
            <p>تصنيف الوزن: <span id="bmiCategoryCoach" style="font-weight: bold;">--</span></p>
            <span class="static-text" id="staticBMIDisplay"></span>
        </div>
    </div>

    <div class="global-actions" id="coachActions">
        <button class="action-button" onclick="saveData()">حفظ البيانات</button>
        <button class="action-button" onclick="loadData()">تحميل البيانات</button>
        <button class="action-button" onclick="showPrintExportPreview()">معاينة الطباعة / التصدير (PDF)</button>
        <button class="action-button" onclick="generateAndCopyTraineeLink()">مشاركة رابط للمتدرب</button> <button class="action-button" id="toggleWeightsColumn" onclick="toggleWeightsColumn()">إخفاء عمود الأوزان</button>
    </div>

    <div class="global-actions" id="traineeActions" style="display:none;">
        <button class="action-button" onclick="saveTraineeProgress()">حفظ تقدم التمارين لهذا الشهر</button>
        <button class="action-button" onclick="exportTraineeData()">تصدير تقاريري (PDF)</button>
    </div>

    <div id="workoutTableContainer">
        <table>
            <thead>
                <tr>
                    <th>اليوم</th>
                    <th>الكايستنكس <span class="level-display" id="calisthenicsLevelDisplay"></span></th>
                    <th class="optional-weights-column weights-column-header">الأوزان <span class="level-display" id="weightsLevelDisplay"></span></th>
                </tr>
            </thead>
            <tbody>
                <script>
                    const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];

                    days.forEach(day => {
                        document.write(`
                            <tr>
                                <td>${day}</td>
                                <td>
                                    <div class="day-exercises-container" id="calisthenics-${day}">
                                        <div class="main-exercise-group">
                                            <div class="group-header">
                                                <span contenteditable="true" class="editable group-title" data-placeholder="اسم مجموعة الكايستنكس"></span>
                                                <div class="group-controls">
                                                    <button class="remove-group-btn" onclick="removeGroup(this)">حذف المجموعة</button>
                                                </div>
                                            </div>
                                            <div class="exercise-section">
                                                <div class="exercise-item">
                                                    <div class="exercise-image-container" onclick="showMediaOptions(this)">
                                                        <input type="file" accept="image/*,video/*" style="display:none;" onchange="handleFileUpload(this, event)">
                                                        <span class="placeholder-text">اضغط لإضافة صورة/فيديو</span>
                                                        <button class="remove-image-btn" onclick="removeMedia(event, this)">X</button>
                                                    </div>
                                                    <span contenteditable="true" class="editable" data-placeholder="اسم التمرين"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="المجموعات"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="العدات"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="الوقت"></span>
                                                    <input type="number" class="trainee-input-field" placeholder="عدات / وقت فعلي" min="0" style="display:none;"> <button class="remove-btn" onclick="removeItem(this)">حذف</button>
                                                </div>
                                            </div>
                                            <div class="controls">
                                                <button class="add-btn" onclick="addItem(this.closest('.main-exercise-group').querySelector('.exercise-section'), 'calisthenics')">إضافة تمرين</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="add-group-btn" onclick="addGroup('calisthenics-${day}', 'calisthenics')">إضافة مجموعة كايستنكس</button>
                                    </div>
                                </td>
                                <td class="optional-weights-column weights-column-data">
                                    <div class="day-exercises-container" id="weights-${day}">
                                        <div class="main-exercise-group">
                                            <div class="group-header">
                                                <span contenteditable="true" class="editable group-title" data-placeholder="اسم مجموعة الأوزان"></span>
                                                <div class="group-controls">
                                                    <button class="remove-group-btn" onclick="removeGroup(this)">حذف المجموعة</button>
                                                </div>
                                            </div>
                                            <div class="exercise-section">
                                                <div class="exercise-item">
                                                    <div class="exercise-image-container" onclick="showMediaOptions(this)">
                                                        <input type="file" accept="image/*,video/*" style="display:none;" onchange="handleFileUpload(this, event)">
                                                        <span class="placeholder-text">اضغط لإضافة صورة/فيديو</span>
                                                        <button class="remove-image-btn" onclick="removeMedia(event, this)">X</button>
                                                    </div>
                                                    <span contenteditable="true" class="editable" data-placeholder="اسم التمرين"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="المجموعات"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="العدات"></span>
                                                    <span contenteditable="true" class="editable" data-placeholder="الوزن"></span>
                                                    <input type="number" class="trainee-input-field" placeholder="وزن فعلي" min="0" style="display:none;"> <button class="remove-btn" onclick="removeItem(this)">حذف</button>
                                                </div>
                                            </div>
                                            <div class="controls">
                                                <button class="add-btn" onclick="addItem(this.closest('.main-exercise-group').querySelector('.exercise-section'), 'weights')">إضافة تمرين</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="controls">
                                        <button class="add-group-btn" onclick="addGroup('weights-${day}', 'weights')">إضافة مجموعة أوزان</button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });
                </script>
            </tbody>
        </table>
    </div>

    <div id="traineeProgressSection" style="display:none;">
        <h2>تتبع التقدم الشهري للتمارين</h2>
        <div id="traineeMonthSelector">
            <button onclick="changeMonth(-1)">الشهر السابق</button>
            <span id="currentMonthDisplay"></span>
            <button onclick="changeMonth(1)">الشهر التالي</button>
        </div>
        <div id="dailyProgressInputs" style="text-align: center;">
            <p>أدخل ما أنجزته لكل تمرين في هذا اليوم من هذا الشهر. (سيتم حفظه تلقائياً)</p>
            </div>
        <div class="trainee-summary" id="monthlySummary">
            <h3>ملخص التقدم الشهري</h3>
            <div id="monthlySummaryContent">
                </div>
        </div>
        <div class="trainee-summary" id="weeklySummary">
            <h3>ملخص التقدم الأسبوعي الحالي</h3>
            <div id="weeklySummaryContent">
                </div>
        </div>
        <div class="trainee-summary" id="dailySummary">
            <h3>ملخص التقدم اليومي الحالي</h3>
            <div id="dailySummaryContent">
                </div>
        </div>
    </div>

    <div id="bmiTrackerSection" style="display:none;">
        <h2>تتبع مؤشر كتلة الجسم (BMI)</h2>
        <div id="bmiEntryForm">
            <div>
                <label for="traineeHeightCm">الطول (سم):</label>
                <input type="number" id="traineeHeightCm" placeholder="طولك بالسم" min="1" oninput="calculateAndDisplayTraineeBMI()">
            </div>
            <div>
                <label for="traineeCurrentWeightKg">الوزن (كجم):</label>
                <input type="number" id="traineeCurrentWeightKg" placeholder="وزنك الحالي بالكجم" min="1" oninput="calculateAndDisplayTraineeBMI()">
            </div>
            <button id="addWeightEntryBtn" onclick="addWeightEntry()">إضافة قراءة وزن</button>
        </div>
        <div id="bmiDisplayArea">
            <p>مؤشر كتلة الجسم (BMI): <span id="bmiDisplay">--</span></p>
            <p>تصنيف الوزن: <span id="bmiCategory">--</span></p>
            <p id="heightWeightDisplay">الطول: -- سم، الوزن: -- كجم</p>
        </div>
        <div id="bmiHistory">
            <h3>سجل قراءات الوزن ومؤشر كتلة الجسم</h3>
            <ul id="bmiHistoryList">
                </ul>
        </div>
    </div>


    <div class="pdf-export-overlay" id="previewOverlay">
        <div class="pdf-content">
            <div class="pdf-preview-header">
                <h2>معاينة الطباعة / التصدير</h2>
                <div class="pdf-preview-actions">
                    <button class="pdf-action-btn" onclick="printPreviewContent()">طباعة</button>
                    <button class="pdf-action-btn" onclick="exportToPdf()">تصدير PDF</button>
                    <button class="pdf-close-btn" onclick="closePreview()">X</button>
                </div>
            </div>
            <div id="previewContent">
            </div>
        </div>
    </div>

    <script>
        let isTraineeMode = false;
        let currentTraineeMonth = new Date().getMonth(); // 0-11
        let currentTraineeYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', (event) => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const dataToLoadFromKey = urlParams.get('data_key'); // For initial data load from coach link

            if (mode === 'trainee') {
                isTraineeMode = true;
                enterTraineeMode(dataToLoadFromKey);
            } else {
                // Coach Mode
                loadData('coachSchedule'); // Load coach's own schedule
                updateStaticPlayerInfo();
                applyColumnVisibility();
                calculateAndDisplayBMI(); // Calculate BMI for coach's view
            }
            updateMonthDisplay(); // For exercise progress
            loadTraineeBMIHistory(); // Load BMI history for trainee if applicable
            calculateAndDisplayTraineeBMI(); // Calculate and display trainee BMI on load
        });

        // Function to convert months to years and months string
        function convertMonthsToYearsMonths(totalMonths) {
            if (isNaN(totalMonths) || totalMonths < 0) {
                return '';
            }
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;

            let result = [];
            if (years > 0) {
                result.push(`${years} سنة`);
            }
            if (months > 0) {
                result.push(`${months} أشهر`);
            }
            if (years === 0 && months === 0 && totalMonths === 0) {
                 return '0 أشهر';
            }
            return result.join(' و ');
        }

        // Function to update the displayed achieved duration
        function updateAchievedDuration() {
            const inputMonths = parseInt(document.getElementById('currentMonthsAchieved').value, 10);
            document.getElementById('staticCurrentMonthsAchieved').innerText = convertMonthsToYearsMonths(inputMonths);
        }

        // Function to create a new exercise item
        function createExerciseItem(type) {
            const exerciseItem = document.createElement('div');
            exerciseItem.className = 'exercise-item';
            exerciseItem.innerHTML = `
                <div class="exercise-image-container" onclick="showMediaOptions(this)">
                    <input type="file" accept="image/*,video/*" style="display:none;" onchange="handleFileUpload(this, event)">
                    <span class="placeholder-text">اضغط لإضافة صورة/فيديو</span>
                    <button class="remove-image-btn" onclick="removeMedia(event, this)">X</button>
                </div>
                <span contenteditable="true" class="editable" data-placeholder="اسم التمرين"></span>
                <span contenteditable="true" class="editable" data-placeholder="المجموعات"></span>
                <span contenteditable="true" class="editable" data-placeholder="العدات"></span>
                ${type === 'weights' ? '<span contenteditable="true" class="editable" data-placeholder="الوزن"></span><input type="number" class="trainee-input-field" placeholder="وزن فعلي" min="0" style="display:none;">' : '<span contenteditable="true" class="editable" data-placeholder="الوقت"></span><input type="number" class="trainee-input-field" placeholder="عدات / وقت فعلي" min="0" style="display:none;">'}
                <button class="remove-btn" onclick="removeItem(this)">حذف</button>
            `;
            return exerciseItem;
        }

        // Function to add an exercise item
        function addItem(sectionElement, type) {
            sectionElement.appendChild(createExerciseItem(type));
        }

        // Function to remove an exercise item
        function removeItem(buttonElement) {
            buttonElement.closest('.exercise-item').remove();
        }

        // Function to create a new exercise group
        function createExerciseGroup(type) {
            const mainGroup = document.createElement('div');
            mainGroup.className = 'main-exercise-group';
            mainGroup.innerHTML = `
                <div class="group-header">
                    <span contenteditable="true" class="editable group-title" data-placeholder="اسم مجموعة ${type === 'calisthenics' ? 'الكايستنكس' : 'الأوزان'}"></span>
                    <div class="group-controls">
                        <button class="remove-group-btn" onclick="removeGroup(this)">حذف المجموعة</button>
                    </div>
                </div>
                <div class="exercise-section">
                    </div>
                <div class="controls">
                    <button class="add-btn" onclick="addItem(this.closest('.main-exercise-group').querySelector('.exercise-section'), '${type}')">إضافة تمرين</button>
                </div>
            `;
            mainGroup.querySelector('.exercise-section').appendChild(createExerciseItem(type));
            return mainGroup;
        }

        // Function to add an exercise group
        function addGroup(containerId, type) {
            const container = document.getElementById(containerId);
            container.appendChild(createExerciseGroup(type));
        }

        // Function to remove an exercise group
        function removeGroup(buttonElement) {
            buttonElement.closest('.main-exercise-group').remove();
        }

        // Function to show media options (file upload or URL)
        function showMediaOptions(container) {
            if (isTraineeMode) return; // Prevent media changes in trainee mode

            const fileInput = container.querySelector('input[type="file"]');
            const currentMedia = container.querySelector('img, video, iframe');

            if (currentMedia) {
                const confirmReplace = confirm("هل تريد تغيير الصورة/الفيديو أو حذفه؟\n\nاضغط موافق للتغيير، إلغاء للحذف.");
                if (confirmReplace) {
                    fileInput.click();
                } else {
                    removeMedia(event, container.querySelector('.remove-image-btn'));
                }
                return;
            }

            const choice = prompt("كيف تود إضافة الصورة/الفيديو؟\n\n1. تحميل ملف من الجهاز\n2. لصق رابط (URL)");

            if (choice === '1') {
                fileInput.click();
            } else if (choice === '2') {
                const url = prompt("الصق رابط الصورة أو الفيديو هنا:");
                if (url) {
                    addMediaFromUrl(container, url);
                }
            }
        }

        // Function to handle file upload
        function handleFileUpload(input, event) {
            event.stopPropagation();
            const file = input.files[0];
            const container = input.closest('.exercise-image-container');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addMediaToContainer(container, e.target.result, file.type);
                };
                reader.readAsDataURL(file);
            }
        }

        // Function to add media from URL
        function addMediaFromUrl(container, url) {
            let mediaType = '';
            if (/\.(jpeg|jpg|gif|png|webp|bmp)$/i.test(url)) {
                mediaType = 'image';
            } else if (/\.(mp4|webm|ogg)$/i.test(url) || url.includes('youtube.com') || url.includes('vimeo.com')) {
                mediaType = 'video';
            } else {
                alert("الرابط لا يبدو كصورة أو فيديو صالح. يرجى التأكد من أن الرابط مباشر أو رابط يوتيوب/فيميو.");
                return;
            }

            if (mediaType === 'video' && url.includes('youtube.com')) {
                const videoId = url.includes('watch?v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                url = `https://www.youtube.com/embed/${videoId}`; // Use embed URL
            } else if (mediaType === 'video' && url.includes('vimeo.com')) {
                const videoId = url.split('/').pop();
                url = `https://player.vimeo.com/video/${videoId}`;
            }
            
            addMediaToContainer(container, url, mediaType);
        }

        // Helper function to add media element to container
        function addMediaToContainer(container, src, type) {
            container.querySelectorAll('img, video, iframe').forEach(el => el.remove());
            container.classList.add('has-media');
            
            let mediaElement;
            if (type.includes('image')) {
                mediaElement = document.createElement('img');
                mediaElement.src = src;
            } else if (type.includes('video') || type === 'video') {
                if (src.includes('youtube.com/embed') || src.includes('player.vimeo.com/video')) {
                    mediaElement = document.createElement('iframe');
                    mediaElement.src = src;
                    mediaElement.setAttribute('frameborder', '0');
                    mediaElement.setAttribute('allowfullscreen', '');
                    mediaElement.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                } else {
                    mediaElement = document.createElement('video');
                    mediaElement.src = src;
                    mediaElement.controls = false;
                    mediaElement.autoplay = false;
                    mediaElement.loop = false;
                    mediaElement.muted = true;
                }
            } else {
                return;
            }
            
            mediaElement.style.maxWidth = '100%';
            mediaElement.style.maxHeight = '100%';
            mediaElement.style.objectFit = 'cover';
            container.prepend(mediaElement);
            container.querySelector('.remove-image-btn').style.display = 'block';
        }

        // Function to remove media
        function removeMedia(event, buttonElement) {
            event.stopPropagation();
            const container = buttonElement.closest('.exercise-image-container');
            container.querySelectorAll('img, video, iframe').forEach(el => el.remove());
            container.classList.remove('has-media');
            buttonElement.style.display = 'none';
        }

        // Function to get all data from the table
        function getAllData() {
            const data = {
                playerInfo: {
                    playerName: document.getElementById('playerName').value,
                    coachName: document.getElementById('coachName').value,
                    country: document.getElementById('countryInput').value,
                    calisthenicsOverallLevel: document.getElementById('calisthenicsOverallLevel').value,
                    targetLevelMonths: document.getElementById('targetLevelMonths').value,
                    currentMonthsAchieved: document.getElementById('currentMonthsAchieved').value,
                    heightCm: document.getElementById('heightCm').value, // Added height
                    currentWeightKg: document.getElementById('currentWeightKg').value // Added current weight
                },
                workoutData: {}
            };

            const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];

            days.forEach(day => {
                data.workoutData[day] = {
                    calisthenics: [],
                    weights: []
                };

                document.querySelectorAll(`#calisthenics-${day} .main-exercise-group`).forEach(group => {
                    const groupTitle = group.querySelector('.group-title').innerText.trim();
                    const exercises = [];
                    group.querySelectorAll('.exercise-item').forEach(item => {
                        const editableSpans = item.querySelectorAll('.editable');
                        const exerciseName = editableSpans[0] ? editableSpans[0].innerText.trim() : '';
                        const sets = editableSpans[1] ? editableSpans[1].innerText.trim() : '';
                        const reps = editableSpans[2] ? editableSpans[2].innerText.trim() : '';
                        const time = editableSpans[3] ? editableSpans[3].innerText.trim() : '';
                        const mediaElement = item.querySelector('.exercise-image-container img, .exercise-image-container video, .exercise-image-container iframe');
                        const mediaSrc = mediaElement ? mediaElement.src : '';
                        const mediaType = mediaElement ? mediaElement.tagName.toLowerCase() : '';

                        exercises.push({
                            name: exerciseName,
                            sets: sets,
                            reps: reps,
                            time: time,
                            media: mediaSrc,
                            mediaType: mediaType
                        });
                    });
                    data.workoutData[day].calisthenics.push({
                        groupTitle: groupTitle,
                        exercises: exercises
                    });
                });

                document.querySelectorAll(`#weights-${day} .main-exercise-group`).forEach(group => {
                    const groupTitle = group.querySelector('.group-title').innerText.trim();
                    const exercises = [];
                    group.querySelectorAll('.exercise-item').forEach(item => {
                        const editableSpans = item.querySelectorAll('.editable');
                        const exerciseName = editableSpans[0] ? editableSpans[0].innerText.trim() : '';
                        const sets = editableSpans[1] ? editableSpans[1].innerText.trim() : '';
                        const reps = editableSpans[2] ? editableSpans[2].innerText.trim() : '';
                        const weight = editableSpans[3] ? editableSpans[3].innerText.trim() : '';
                        const mediaElement = item.querySelector('.exercise-image-container img, .exercise-image-container video, .exercise-image-container iframe');
                        const mediaSrc = mediaElement ? mediaElement.src : '';
                        const mediaType = mediaElement ? mediaElement.tagName.toLowerCase() : '';

                        exercises.push({
                            name: exerciseName,
                            sets: sets,
                            reps: reps,
                            weight: weight,
                            media: mediaSrc,
                            mediaType: mediaType
                        });
                    });
                    data.workoutData[day].weights.push({
                        groupTitle: groupTitle,
                        exercises: exercises
                    });
                });
            });

            data.weightsColumnHidden = document.getElementById('toggleWeightsColumn').dataset.hidden === 'true';

            return data;
        }

        // Function to populate the table with data
        function populateTable(data) {
            document.getElementById('playerName').value = data.playerInfo.playerName || '';
            document.getElementById('coachName').value = data.playerInfo.coachName || '';
            document.getElementById('countryInput').value = data.playerInfo.country || '';
            document.getElementById('calisthenicsOverallLevel').value = data.playerInfo.calisthenicsOverallLevel || '';
            document.getElementById('targetLevelMonths').value = data.playerInfo.targetLevelMonths || '';
            document.getElementById('currentMonthsAchieved').value = data.playerInfo.currentMonthsAchieved || '';
            document.getElementById('heightCm').value = data.playerInfo.heightCm || ''; // Populate height
            document.getElementById('currentWeightKg').value = data.playerInfo.currentWeightKg || ''; // Populate current weight

            updateAchievedDuration();
            calculateAndDisplayBMI(); // Recalculate BMI after loading coach data
            
            document.getElementById('calisthenicsLevelDisplay').innerText = data.playerInfo.calisthenicsOverallLevel ? `(${data.playerInfo.calisthenicsOverallLevel})` : '';

            const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];

            days.forEach(day => {
                document.getElementById(`calisthenics-${day}`).innerHTML = '';
                document.getElementById(`weights-${day}`).innerHTML = '';

                if (data.workoutData[day] && data.workoutData[day].calisthenics) {
                    data.workoutData[day].calisthenics.forEach(groupData => {
                        const newGroup = createExerciseGroup('calisthenics');
                        newGroup.querySelector('.group-title').innerText = groupData.groupTitle;
                        const exerciseSection = newGroup.querySelector('.exercise-section');
                        exerciseSection.innerHTML = '';

                        groupData.exercises.forEach(exercise => {
                            const newItem = createExerciseItem('calisthenics');
                            const editableSpans = newItem.querySelectorAll('.editable');
                            if (editableSpans[0]) editableSpans[0].innerText = exercise.name;
                            if (editableSpans[1]) editableSpans[1].innerText = exercise.sets;
                            if (editableSpans[2]) editableSpans[2].innerText = exercise.reps;
                            if (editableSpans[3]) editableSpans[3].innerText = exercise.time;
                            if (exercise.media) {
                                addMediaToContainer(newItem.querySelector('.exercise-image-container'), exercise.media, exercise.mediaType);
                            }
                            exerciseSection.appendChild(newItem);
                        });
                        document.getElementById(`calisthenics-${day}`).appendChild(newGroup);
                    });
                }
                if (document.getElementById(`calisthenics-${day}`).children.length === 0) {
                    addGroup(`calisthenics-${day}`, 'calisthenics');
                }
                if (!document.getElementById(`calisthenics-${day}`).nextElementSibling || !document.getElementById(`calisthenics-${day}`).nextElementSibling.classList.contains('controls')) {
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'controls';
                    controlsDiv.innerHTML = `<button class="add-group-btn" onclick="addGroup('calisthenics-${day}', 'calisthenics')">إضافة مجموعة كايستنكس</button>`;
                    document.getElementById(`calisthenics-${day}`).parentElement.appendChild(controlsDiv);
                }

                if (data.workoutData[day] && data.workoutData[day].weights) {
                    data.workoutData[day].weights.forEach(groupData => {
                        const newGroup = createExerciseGroup('weights');
                        newGroup.querySelector('.group-title').innerText = groupData.groupTitle;
                        const exerciseSection = newGroup.querySelector('.exercise-section');
                        exerciseSection.innerHTML = '';

                        groupData.exercises.forEach(exercise => {
                            const newItem = createExerciseItem('weights');
                            const editableSpans = newItem.querySelectorAll('.editable');
                            if (editableSpans[0]) editableSpans[0].innerText = exercise.name;
                            if (editableSpans[1]) editableSpans[1].innerText = exercise.sets;
                            if (editableSpans[2]) editableSpans[2].innerText = exercise.reps;
                            if (editableSpans[3]) editableSpans[3].innerText = exercise.weight;
                            if (exercise.media) {
                                addMediaToContainer(newItem.querySelector('.exercise-image-container'), exercise.media, exercise.mediaType);
                            }
                            exerciseSection.appendChild(newItem);
                        });
                        document.getElementById(`weights-${day}`).appendChild(newGroup);
                    });
                }
                 if (document.getElementById(`weights-${day}`).children.length === 0) {
                    addGroup(`weights-${day}`, 'weights');
                }
                 if (!document.getElementById(`weights-${day}`).nextElementSibling || !document.getElementById(`weights-${day}`).nextElementSibling.classList.contains('controls')) {
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'controls';
                    controlsDiv.innerHTML = `<button class="add-group-btn" onclick="addGroup('weights-${day}', 'weights')">إضافة مجموعة أوزان</button>`;
                    document.getElementById(`weights-${day}`).parentElement.appendChild(controlsDiv);
                }
            });

            if (typeof data.weightsColumnHidden !== 'undefined') {
                const toggleButton = document.getElementById('toggleWeightsColumn');
                if (data.weightsColumnHidden) {
                    hideWeightsColumn();
                    toggleButton.dataset.hidden = 'true';
                    toggleButton.innerText = 'إظهار عمود الأوزان';
                } else {
                    showWeightsColumn();
                    toggleButton.dataset.hidden = 'false';
                    toggleButton.innerText = 'إخفاء عمود الأوزان';
                }
            }
            updateStaticPlayerInfo();
        }

        // Save data to localStorage
        function saveData(key = 'coachSchedule') {
            const data = getAllData();
            localStorage.setItem(key, JSON.stringify(data));
            if (!isTraineeMode) { // Only show alert for coach mode
                alert('تم حفظ البيانات بنجاح!');
            }
        }

        // Load data from localStorage
        function loadData(key = 'coachSchedule') {
            const savedData = localStorage.getItem(key);
            if (savedData) {
                const data = JSON.parse(savedData);
                populateTable(data);
                if (!isTraineeMode) {
                    alert('تم تحميل البيانات بنجاح!');
                }
            } else {
                const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
                days.forEach(day => {
                    if (document.getElementById(`calisthenics-${day}`).children.length === 0) {
                        addGroup(`calisthenics-${day}`, 'calisthenics');
                    }
                    if (document.getElementById(`weights-${day}`).children.length === 0) {
                        addGroup(`weights-${day}`, 'weights');
                    }
                });
            }
        }

        // Update static player info for print preview and trainee mode display
        function updateStaticPlayerInfo() {
            document.getElementById('staticPlayerName').innerText = document.getElementById('playerName').value;
            document.getElementById('staticCoachName').innerText = document.getElementById('coachName').value;
            document.getElementById('staticCountry').innerText = document.getElementById('countryInput').value;
            
            const calisthenicsLevel = document.getElementById('calisthenicsOverallLevel').value;
            const targetMonths = parseInt(document.getElementById('targetLevelMonths').value, 10);
            let levelText = calisthenicsLevel;
            if (!isNaN(targetMonths) && targetMonths > 0) {
                levelText += ` (المستهدف: ${convertMonthsToYearsMonths(targetMonths)})`;
            }
            document.getElementById('staticCalisthenicsOverallLevel').innerText = levelText;

            const currentAchieved = parseInt(document.getElementById('currentMonthsAchieved').value, 10);
            document.getElementById('staticCurrentMonthsAchieved').innerText = convertMonthsToYearsMonths(currentAchieved);

            // Update static BMI display for coach
            const heightCm = parseFloat(document.getElementById('heightCm').value);
            const currentWeightKg = parseFloat(document.getElementById('currentWeightKg').value);
            let bmiValue = '--';
            let bmiCategory = '--';
            if (heightCm > 0 && currentWeightKg > 0) {
                const bmiResult = calculateBMI(currentWeightKg, heightCm);
                bmiValue = bmiResult.bmi.toFixed(2);
                bmiCategory = bmiResult.category;
            }
            document.getElementById('staticBMIDisplay').innerText = `BMI: ${bmiValue}, التصنيف: ${bmiCategory}`;

            // Make sure these are hidden in coach mode but shown in trainee static display
            document.getElementById('staticHeightCm').innerText = document.getElementById('heightCm').value ? `${document.getElementById('heightCm').value} سم` : '--';
            document.getElementById('staticCurrentWeightKg').innerText = document.getElementById('currentWeightKg').value ? `${document.getElementById('currentWeightKg').value} كجم` : '--';
        }

        // Toggle weights column visibility
        function toggleWeightsColumn() {
            const weightsHeaders = document.querySelectorAll('.weights-column-header');
            const weightsDataCells = document.querySelectorAll('.weights-column-data');
            const toggleButton = document.getElementById('toggleWeightsColumn');
            
            const isHidden = toggleButton.dataset.hidden === 'true';

            if (isHidden) {
                showWeightsColumn();
                toggleButton.dataset.hidden = 'false';
                toggleButton.innerText = 'إخفاء عمود الأوزان';
            } else {
                hideWeightsColumn();
                toggleButton.dataset.hidden = 'true';
                toggleButton.innerText = 'إظهار عمود الأوزان';
            }
            localStorage.setItem('weightsColumnHidden', toggleButton.dataset.hidden);
        }

        function hideWeightsColumn() {
            document.querySelectorAll('.weights-column-header, .weights-column-data').forEach(el => {
                el.classList.add('hidden');
                el.classList.add('hidden-for-print');
            });
        }

        function showWeightsColumn() {
            document.querySelectorAll('.weights-column-header, .weights-column-data').forEach(el => {
                el.classList.remove('hidden');
                el.classList.remove('hidden-for-print');
            });
        }

        function applyColumnVisibility() {
            const weightsColumnHidden = localStorage.getItem('weightsColumnHidden');
            const toggleButton = document.getElementById('toggleWeightsColumn');

            if (weightsColumnHidden === 'true') {
                hideWeightsColumn();
                toggleButton.dataset.hidden = 'true';
                toggleButton.innerText = 'إظهار عمود الأوزان';
            } else {
                showWeightsColumn();
                toggleButton.dataset.hidden = 'false';
                toggleButton.innerText = 'إخفاء عمود الأوزان';
            }
        }

        // --- PDF Export and Print Functions ---
        function showPrintExportPreview() {
            const previewOverlay = document.getElementById('previewOverlay');
            const previewContent = document.getElementById('previewContent');
            
            const printTempContainer = document.createElement('div');
            printTempContainer.id = 'printTempContainer';
            printTempContainer.style.visibility = 'hidden';
            printTempContainer.style.position = 'absolute';
            printTempContainer.style.width = 'fit-content';
            printTempContainer.style.height = 'fit-content';
            document.body.appendChild(printTempContainer);

            const clonedPlayerInfo = document.getElementById('playerInfoSection').cloneNode(true);
            clonedPlayerInfo.querySelectorAll('input').forEach(input => {
                const staticTextSpan = input.nextElementSibling;
                if (staticTextSpan && staticTextSpan.classList.contains('static-text')) {
                    if (input.id === 'currentMonthsAchieved') {
                        staticTextSpan.innerText = convertMonthsToYearsMonths(parseInt(input.value, 10));
                    } else if (input.id === 'heightCm' || input.id === 'currentWeightKg') {
                        // These are handled by specific static texts for BMI
                        input.style.display = 'none';
                        staticTextSpan.style.display = 'block'; // Make sure the specific static texts are visible
                    }
                     else {
                        staticTextSpan.innerText = input.value;
                        input.style.display = 'none';
                        staticTextSpan.style.display = 'block';
                    }
                } else {
                    input.style.display = 'none'; // Hide any remaining inputs
                }
            });

            // Handle BMI display for print preview
            const heightCmVal = parseFloat(document.getElementById('heightCm').value);
            const currentWeightKgVal = parseFloat(document.getElementById('currentWeightKg').value);
            const bmiResult = calculateBMI(currentWeightKgVal, heightCmVal);

            const bmiCoachDisplay = clonedPlayerInfo.querySelector('#bmiCoachDisplay');
            if (bmiCoachDisplay) {
                bmiCoachDisplay.innerHTML = `
                    <p>الطول: ${heightCmVal > 0 ? heightCmVal + ' سم' : '--'}</p>
                    <p>الوزن: ${currentWeightKgVal > 0 ? currentWeightKgVal + ' كجم' : '--'}</p>
                    <p>مؤشر كتلة الجسم (BMI): <span style="font-weight: bold; color: #0056b3;">${bmiResult.bmi !== 'N/A' ? bmiResult.bmi.toFixed(2) : '--'}</span></p>
                    <p>تصنيف الوزن: <span style="font-weight: bold; color: ${getBmiColor(bmiResult.category)};">${bmiResult.category}</span></p>
                `;
            }

            const staticCalisthenicsOverallLevel = clonedPlayerInfo.querySelector('#staticCalisthenicsOverallLevel');
            const calisthenicsLevelInput = document.getElementById('calisthenicsOverallLevel').value;
            const targetLevelMonthsInput = parseInt(document.getElementById('targetLevelMonths').value, 10);
            let combinedLevelText = calisthenicsLevelInput;
            if (!isNaN(targetLevelMonthsInput) && targetLevelMonthsInput > 0) {
                combinedLevelText += ` (المستهدف: ${convertMonthsToYearsMonths(targetLevelMonthsInput)})`;
            }
            staticCalisthenicsOverallLevel.innerText = combinedLevelText;
            clonedPlayerInfo.querySelector('#calisthenicsOverallLevel').style.display = 'none';
            clonedPlayerInfo.querySelector('#targetLevelMonths').style.display = 'none';
            clonedPlayerInfo.querySelector('#staticTargetLevelMonths').style.display = 'none';


            printTempContainer.appendChild(clonedPlayerInfo);

            const workoutTable = document.querySelector('#workoutTableContainer table').cloneNode(true);
            workoutTable.classList.add('workout-table-for-print');

            workoutTable.querySelectorAll('.editable').forEach(editable => {
                editable.removeAttribute('contenteditable');
                if (editable.innerText.trim() === '') {
                    editable.innerText = editable.getAttribute('data-placeholder');
                    editable.style.color = '#777';
                }
                editable.style.border = 'none';
                editable.style.padding = '0';
                editable.style.backgroundColor = 'transparent';
                editable.style.outline = 'none';
                editable.style.color = '#333';
            });

            workoutTable.querySelectorAll('.exercise-image-container').forEach(container => {
                const mediaElement = container.querySelector('img, video, iframe');
                if (mediaElement) {
                    container.classList.add('has-media');
                    container.querySelector('.placeholder-text').style.display = 'none';
                    container.querySelector('.remove-image-btn').style.display = 'none';
                    if (mediaElement.tagName.toLowerCase() === 'video') {
                        mediaElement.controls = false;
                        mediaElement.autoplay = false;
                        mediaElement.loop = false;
                        mediaElement.muted = true;
                    }
                } else {
                    container.style.display = 'none';
                }
            });

            const isWeightsHidden = document.getElementById('toggleWeightsColumn').dataset.hidden === 'true';
            workoutTable.querySelectorAll('.weights-column-header, .weights-column-data').forEach(el => {
                if (isWeightsHidden) {
                    el.classList.add('hidden-for-print');
                } else {
                    el.classList.remove('hidden-for-print');
                }
            });

            workoutTable.querySelectorAll('.controls, .add-btn, .remove-btn, .add-group-btn, .remove-group-btn, .group-controls, .trainee-input-field').forEach(el => {
                el.remove();
            });

            printTempContainer.appendChild(workoutTable);
            
            // If in trainee mode, also include the progress summaries and BMI tracker
            if (isTraineeMode) {
                const traineeProgressSummaryClone = document.getElementById('traineeProgressSection').cloneNode(true);
                traineeProgressSummaryClone.style.display = 'block'; // Ensure it's visible in preview
                traineeProgressSummaryClone.querySelectorAll('.trainee-input-field, .trainee-save-btn, #traineeMonthSelector').forEach(el => el.remove()); // Remove inputs/buttons
                
                // Regenerate summaries for the current month being viewed in trainee mode
                loadTraineeProgressForMonth(currentTraineeMonth, currentTraineeYear);
                updateSummariesDisplay(traineeProgressSummaryClone); // Pass the cloned element
                
                printTempContainer.appendChild(traineeProgressSummaryClone);

                // Add BMI Tracker section to print
                const bmiTrackerSectionClone = document.getElementById('bmiTrackerSection').cloneNode(true);
                bmiTrackerSectionClone.style.display = 'block'; // Ensure it's visible
                bmiTrackerSectionClone.querySelectorAll('#bmiEntryForm, #addWeightEntryBtn').forEach(el => el.remove()); // Remove input form and add button
                bmiTrackerSectionClone.querySelector('#bmiDisplayArea p:nth-child(1)').innerText = `مؤشر كتلة الجسم (BMI): ${document.getElementById('bmiDisplay').innerText}`;
                bmiTrackerSectionClone.querySelector('#bmiDisplayArea p:nth-child(2)').innerText = `تصنيف الوزن: ${document.getElementById('bmiCategory').innerText}`;
                bmiTrackerSectionClone.querySelector('#heightWeightDisplay').innerText = `الطول: ${document.getElementById('traineeHeightCm').value || '--'} سم، الوزن: ${document.getElementById('traineeCurrentWeightKg').value || '--'} كجم`;

                // Re-render history list without remove buttons
                const bmiHistoryListClone = bmiTrackerSectionClone.querySelector('#bmiHistoryList');
                bmiHistoryListClone.innerHTML = ''; // Clear existing
                const bmiHistory = JSON.parse(localStorage.getItem('traineeBMIHistory') || '[]');
                bmiHistory.forEach(entry => {
                    const li = document.createElement('li');
                    li.innerHTML = `تاريخ: ${entry.date}، الوزن: ${entry.weight} كجم، BMI: ${entry.bmi.toFixed(2)} (${entry.category})`;
                    bmiHistoryListClone.appendChild(li);
                });


                printTempContainer.appendChild(bmiTrackerSectionClone);
            }

            previewContent.innerHTML = printTempContainer.innerHTML;
            document.body.removeChild(printTempContainer);
            previewOverlay.style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('previewOverlay').style.display = 'none';
            document.querySelectorAll('#playerInfoSection input').forEach(input => {
                input.style.display = 'block';
                const staticTextSpan = input.nextElementSibling;
                if (staticTextSpan) {
                    staticTextSpan.style.display = 'none';
                }
            });
            document.getElementById('staticCalisthenicsOverallLevel').style.display = 'none';
            document.getElementById('staticBMIDisplay').style.display = 'none';
        }

        function printPreviewContent() {
            const content = document.getElementById('previewContent');
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write('<!DOCTYPE html><html><head><title>جدول التمارين</title>');
            document.querySelectorAll('style').forEach(style => {
                printWindow.document.write(style.outerHTML);
            });
            printWindow.document.write('</head><body>');
            printWindow.document.write(content.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        }

        function exportToPdf() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('previewContent');

            // Set height of the content div to auto before html2canvas to ensure all content is rendered
            content.style.height = 'auto'; 
            html2canvas(content, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('جدول_التمارين.pdf');
            }).finally(() => {
                // Reset height of content div after html2canvas
                content.style.height = ''; 
            });
        }


        // --- Trainee Mode Logic ---
        function enterTraineeMode(dataKeyToLoad = null) {
            document.body.classList.add('trainee-mode');
            document.getElementById('coachActions').style.display = 'none';
            document.getElementById('traineeActions').style.display = 'flex';
            document.getElementById('traineeProgressSection').style.display = 'block';
            document.getElementById('bmiTrackerSection').style.display = 'block'; // Show BMI tracker for trainee

            // Disable all editable content
            document.querySelectorAll('.editable').forEach(el => {
                el.removeAttribute('contenteditable');
                // Ensure placeholder text is not visible in trainee mode when content exists
                if (el.innerText.trim() === '' && el.hasAttribute('data-placeholder')) {
                    el.innerText = el.getAttribute('data-placeholder');
                    el.style.color = '#777';
                } else if (el.innerText.trim() !== '') {
                    el.style.color = '#333';
                }
            });

            // Hide add/remove buttons and image upload functionality for trainee
            document.querySelectorAll('.add-btn, .remove-btn, .add-group-btn, .remove-group-btn, .group-controls').forEach(btn => {
                btn.style.display = 'none';
            });
            document.querySelectorAll('.exercise-image-container').forEach(container => {
                container.removeAttribute('onclick'); // Disable click to upload
                container.querySelector('input[type="file"]').style.display = 'none'; // Hide input
                if (container.querySelector('.remove-image-btn')) {
                    container.querySelector('.remove-image-btn').style.display = 'none';
                }
            });

            // Show trainee input fields for daily progress
            document.querySelectorAll('.trainee-input-field').forEach(input => {
                input.style.display = 'inline-block';
                input.addEventListener('input', (event) => saveTraineeProgressDaily(event.target)); // Save on input
            });

            // Hide coach's player info inputs and show static text
            document.querySelectorAll('#playerInfoSection input').forEach(input => {
                input.style.display = 'none';
                const staticTextSpan = input.nextElementSibling;
                if (staticTextSpan) {
                    staticTextSpan.style.display = 'block';
                }
            });
            // Ensure the merged level text is shown
            document.getElementById('staticCalisthenicsOverallLevel').style.display = 'block';
            document.getElementById('staticBMIDisplay').style.display = 'block'; // Show combined BMI static text

            // Hide BMI coach display specific elements
            document.getElementById('bmiValueCoach').style.display = 'none';
            document.getElementById('bmiCategoryCoach').style.display = 'none';
            document.getElementById('bmiCoachDisplay').style.display = 'none';


            // Load data based on the dataKey provided in the URL
            if (dataKeyToLoad === 'tempTraineeShareData') {
                const tempTraineeShareData = localStorage.getItem('tempTraineeShareData');
                if (tempTraineeShareData) {
                    localStorage.setItem('coachSchedule_traineeCopy', tempTraineeShareData); // Copy to trainee's permanent storage
                    loadData('coachSchedule_traineeCopy'); // Load this copy
                    alert('تم استيراد جدول التمارين من المدرب بنجاح!');
                    // Clear the URL param after import to keep URL clean, but keep mode=trainee
                    window.history.replaceState({}, document.title, window.location.pathname + '?mode=trainee');
                } else {
                    console.warn("No temporary trainee share data found. Loading trainee's own saved data.");
                    loadData('coachSchedule_traineeCopy');
                }
            } else {
                // If no data key, or if it's not the temp key, just load trainee's own saved data
                loadData('coachSchedule_traineeCopy');
            }
            
            updateMonthDisplay(); // For exercise progress
            loadTraineeBMIHistory(); // Load BMI history for trainee
            calculateAndDisplayTraineeBMI(); // Calculate and display trainee BMI on load
        }

        function generateAndCopyTraineeLink() {
            const currentScheduleData = getAllData();
            // Store the data in local storage for the trainee to pick up
            localStorage.setItem('tempTraineeShareData', JSON.stringify(currentScheduleData));
            
            // Construct the URL for the trainee
            const traineeUrl = `${window.location.origin}${window.location.pathname}?mode=trainee&data_key=tempTraineeShareData`; 
            
            navigator.clipboard.writeText(traineeUrl)
                .then(() => {
                    alert('تم إنشاء ونسخ رابط المتدرب بنجاح! يمكن للمتدرب فتح هذا الرابط في متصفحه.');
                })
                .catch(err => {
                    console.error('فشل في نسخ الرابط:', err);
                    alert('فشل في نسخ الرابط. الرجاء نسخه يدوياً:\n' + traineeUrl);
                });
        }

        // --- Trainee Progress Tracking ---

        const monthNames = [
            "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
            "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
        ];

        function updateMonthDisplay() {
            document.getElementById('currentMonthDisplay').innerText = 
                `${monthNames[currentTraineeMonth]} ${currentTraineeYear}`;
        }

        function changeMonth(delta) {
            currentTraineeMonth += delta;
            if (currentTraineeMonth > 11) {
                currentTraineeMonth = 0;
                currentTraineeYear++;
            } else if (currentTraineeMonth < 0) {
                currentTraineeMonth = 11;
                currentTraineeYear--;
            }
            updateMonthDisplay();
            loadTraineeProgressForMonth(currentTraineeMonth, currentTraineeYear);
        }

        // Load progress for a specific month
        function loadTraineeProgressForMonth(month, year) {
            const progressKey = `traineeProgress_${year}_${month}`;
            const savedProgress = localStorage.getItem(progressKey);
            let progressData = savedProgress ? JSON.parse(savedProgress) : {};

            const days = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];

            days.forEach(day => {
                const calisthenicsGroups = document.querySelectorAll(`#calisthenics-${day} .main-exercise-group`);
                const weightsGroups = document.querySelectorAll(`#weights-${day} .main-exercise-group`);

                calisthenicsGroups.forEach((group, groupIndex) => {
                    group.querySelectorAll('.exercise-item').forEach((item, itemIndex) => {
                        const inputField = item.querySelector('.trainee-input-field');
                        if (inputField) {
                            const dailyValue = progressData[day]?.[groupIndex]?.calisthenics?.[itemIndex] || '';
                            inputField.value = dailyValue;
                        }
                    });
                });

                weightsGroups.forEach((group, groupIndex) => {
                    group.querySelectorAll('.exercise-item').forEach((item, itemIndex) => {
                        const inputField = item.querySelector('.trainee-input-field');
                        if (inputField) {
                            const dailyValue = progressData[day]?.[groupIndex]?.weights?.[itemIndex] || '';
                            inputField.value = dailyValue;
                        }
                    });
                });
            });
            updateSummariesDisplay(document); // Update summaries for the current view
        }
        
        // Save daily progress on input
        function saveTraineeProgressDaily(inputElement) {
            const progressKey = `traineeProgress_${currentTraineeYear}_${currentTraineeMonth}`;
            let progressData = localStorage.getItem(progressKey);
            progressData = progressData ? JSON.parse(progressData) : {};

            const item = inputElement.closest('.exercise-item');
            const group = item.closest('.main-exercise-group');
            const dayContainer = group.closest('.day-exercises-container');

            const day = dayContainer.id.split('-')[1];
            const type = dayContainer.id.split('-')[0]; // 'calisthenics' or 'weights'

            const allGroupsInDayContainer = Array.from(dayContainer.querySelectorAll('.main-exercise-group'));
            const groupIndex = allGroupsInDayContainer.indexOf(group);

            const allItemsInGroup = Array.from(group.querySelectorAll('.exercise-item'));
            const itemIndex = allItemsInGroup.indexOf(item);

            if (!progressData[day]) progressData[day] = {};
            if (!progressData[day][groupIndex]) progressData[day][groupIndex] = { calisthenics: [], weights: [] };
            
            if (type === 'calisthenics') {
                progressData[day][groupIndex].calisthenics[itemIndex] = inputElement.value;
            } else {
                progressData[day][groupIndex].weights[itemIndex] = inputElement.value;
            }

            localStorage.setItem(progressKey, JSON.stringify(progressData));
            updateSummariesDisplay(document); // Update summaries immediately after change
        }

        // Save progress (manual button click for monthly save)
        function saveTraineeProgress() {
            // This function is mostly for explicit saving, daily saves happen on input
            alert('تم حفظ تقدم التمارين لهذا الشهر تلقائياً عند الإدخال. يمكنك مراجعة الملخصات بالأسفل.');
        }

        function getMonthlyProgressData(month, year) {
            const progressKey = `traineeProgress_${year}_${month}`;
            const savedProgress = localStorage.getItem(progressKey);
            return savedProgress ? JSON.parse(savedProgress) : {};
        }

        // Update all summary displays
        function updateSummariesDisplay(targetElement) {
            // targetElement can be 'document' for live view or 'cloned element' for print preview
            const monthlyData = getMonthlyProgressData(currentTraineeMonth, currentTraineeYear);
            
            // Daily Summary
            const today = new Date();
            const currentDayIndex = today.getDay(); // 0 for Sunday, 6 for Saturday
            const currentDayName = days[currentDayIndex]; // Map to Arabic day name array

            let dailyTotalCalisthenics = 0;
            let dailyTotalWeights = 0;
            let dailySummaryText = `لا توجد بيانات لهذا اليوم (${currentDayName}).`;

            if (monthlyData[currentDayName]) {
                monthlyData[currentDayName].forEach(group => {
                    if (group.calisthenics) {
                        group.calisthenics.forEach(val => dailyTotalCalisthenics += (parseFloat(val) || 0));
                    }
                    if (group.weights) {
                        group.weights.forEach(val => dailyTotalWeights += (parseFloat(val) || 0));
                    }
                });
                if (dailyTotalCalisthenics > 0 || dailyTotalWeights > 0) {
                    dailySummaryText = `
                        <div>إجمالي الكاليستنكس: <span>${dailyTotalCalisthenics}</span> وحدة</div>
                        <div>إجمالي الأوزان: <span>${dailyTotalWeights}</span> وحدة</div>
                    `;
                }
            }
            targetElement.getElementById('dailySummaryContent').innerHTML = dailySummaryText;

            // Weekly Summary (for the current week of the selected month)
            let weeklyTotalCalisthenics = 0;
            let weeklyTotalWeights = 0;
            let weeklySummaryText = 'لا توجد بيانات لهذا الأسبوع.';

            // Get the current day of the week for the selected month/year
            // Find the first day of the *actual* week that contains the first day of the currentTraineeMonth
            const firstDayOfCurrentMonth = new Date(currentTraineeYear, currentTraineeMonth, 1);
            const startOfWeekOffset = firstDayOfCurrentMonth.getDay(); // 0 for Sunday, 6 for Saturday. This is the offset from Sunday to the 1st of the month.
            
            // Calculate the actual date of the first day of the week (Sunday)
            const firstSunday = new Date(firstDayOfCurrentMonth);
            firstSunday.setDate(firstDayOfCurrentMonth.getDate() - startOfWeekOffset);


            // Iterate through the 7 days of the week starting from firstSunday
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(firstSunday);
                dayDate.setDate(firstSunday.getDate() + i);
                
                // Ensure we are summarizing for the *current* month selected in the tracker, not always "today's" week
                // This logic might need refinement if you want to track week by week for ALL weeks in a month
                // For now, this calculates the week containing the FIRST day of the month shown.
                // A more robust weekly tracker would iterate through all days of the selected month and group them by week.
                // For simplicity, let's just sum up current month data for all days.
                // If you need strict week-by-week tracking, this section needs a more complex date iteration.
                
                // Let's simplify and summarize just for the current month displayed.
                // A "weekly summary" for the current displayed month is a bit ambiguous if not tied to actual dates.
                // For now, let's just sum all available daily data within the current month for "weekly" summary.
                // This means the weekly summary will reflect the sum of all days in the current month's recorded data.
                // A true weekly summary would need to know which week number it is in the month/year.

                // Let's make this simple: Weekly summary is for the current day's week.
                // This assumes the user inputs progress on the *current actual date*.

                // Let's revert to a simpler "weekly summary" that is derived from the *actual current week on the calendar*
                // not just the *displayed month's first week*. This makes more sense for a user.

                // Re-calculate weekly summary based on actual current week (relative to today's date)
                const currentWeekStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay()); // Sunday of current week
                const currentWeekEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (6 - today.getDay())); // Saturday of current week

                weeklyTotalCalisthenics = 0;
                weeklyTotalWeights = 0;
                weeklySummaryText = 'لا توجد بيانات لهذا الأسبوع.';

                for (let j = 0; j < 7; j++) {
                    const weekDayDate = new Date(currentWeekStart);
                    weekDayDate.setDate(currentWeekStart.getDate() + j);
                    const dayNameForWeek = days[weekDayDate.getDay()]; // Get Arabic day name

                    // Check if this day's data exists and falls within the currently selected month/year of the progress tracker
                    if (weekDayDate.getMonth() === currentTraineeMonth && weekDayDate.getFullYear() === currentTraineeYear) {
                         const currentDayData = monthlyData[dayNameForWeek];
                        if (currentDayData) {
                            currentDayData.forEach(group => {
                                if (group.calisthenics) {
                                    group.calisthenics.forEach(val => weeklyTotalCalisthenics += (parseFloat(val) || 0));
                                }
                                if (group.weights) {
                                    group.weights.forEach(val => weeklyTotalWeights += (parseFloat(val) || 0));
                                }
                            });
                        }
                    }
                }
            }
            
            if (weeklyTotalCalisthenics > 0 || weeklyTotalWeights > 0) {
                weeklySummaryText = `
                    <div>إجمالي الكاليستنكس هذا الأسبوع: <span>${weeklyTotalCalisthenics}</span> وحدة</div>
                    <div>إجمالي الأوزان هذا الأسبوع: <span>${weeklyTotalWeights}</span> وحدة</div>
                `;
            }
            targetElement.getElementById('weeklySummaryContent').innerHTML = weeklySummaryText;

            // Monthly Summary
            let monthlyTotalCalisthenics = 0;
            let monthlyTotalWeights = 0;
            let monthlySummaryText = 'لا توجد بيانات لهذا الشهر.';

            for (const day of days) {
                if (monthlyData[day]) {
                    monthlyData[day].forEach(group => {
                        if (group.calisthenics) {
                            group.calisthenics.forEach(val => monthlyTotalCalisthenics += (parseFloat(val) || 0));
                        }
                        if (group.weights) {
                            group.weights.forEach(val => monthlyTotalWeights += (parseFloat(val) || 0));
                        }
                    });
                }
            }
            if (monthlyTotalCalisthenics > 0 || monthlyTotalWeights > 0) {
                monthlySummaryText = `
                    <div>إجمالي الكاليستنكس هذا الشهر: <span>${monthlyTotalCalisthenics}</span> وحدة</div>
                    <div>إجمالي الأوزان هذا الشهر: <span>${monthlyTotalWeights}</span> وحدة</div>
                `;
            }
            targetElement.getElementById('monthlySummaryContent').innerHTML = monthlySummaryText;
        }


        function exportTraineeData() {
            showPrintExportPreview(); // Use the existing print preview logic
        }

        // --- BMI Calculation and Tracking ---

        function calculateBMI(weightKg, heightCm) {
            let bmi = 'N/A';
            let category = 'غير معروف';

            if (weightKg > 0 && heightCm > 0) {
                const heightM = heightCm / 100; // Convert cm to meters
                bmi = weightKg / (heightM * heightM);

                if (bmi < 18.5) {
                    category = 'نقص وزن';
                } else if (bmi >= 18.5 && bmi < 25) {
                    category = 'وزن صحي';
                } else if (bmi >= 25 && bmi < 30) {
                    category = 'زيادة وزن';
                } else {
                    category = 'سمنة';
                }
            }
            return { bmi: bmi, category: category };
        }

        function getBmiColor(category) {
            switch(category) {
                case 'نقص وزن': return '#ffc107'; // Yellow
                case 'وزن صحي': return '#28a745'; // Green
                case 'زيادة وزن': return '#fd7e14'; // Orange
                case 'سمنة': return '#dc3545'; // Red
                default: return '#333';
            }
        }

        // For Coach's view: calculate and display BMI based on initial/current inputs
        function calculateAndDisplayBMI() {
            const heightCm = parseFloat(document.getElementById('heightCm').value);
            const currentWeightKg = parseFloat(document.getElementById('currentWeightKg').value);
            const bmiResult = calculateBMI(currentWeightKg, heightCm);

            const bmiValueElement = document.getElementById('bmiValueCoach');
            const bmiCategoryElement = document.getElementById('bmiCategoryCoach');

            bmiValueElement.innerText = bmiResult.bmi !== 'N/A' ? bmiResult.bmi.toFixed(2) : '--';
            bmiCategoryElement.innerText = bmiResult.category;
            bmiCategoryElement.style.color = getBmiColor(bmiResult.category);
            updateStaticPlayerInfo(); // Update static text for print/trainee
        }

        // For Trainee's view: calculate and display BMI based on their own inputs
        function calculateAndDisplayTraineeBMI() {
            if (!isTraineeMode) return;
            const heightCm = parseFloat(document.getElementById('traineeHeightCm').value);
            const currentWeightKg = parseFloat(document.getElementById('traineeCurrentWeightKg').value);
            const bmiResult = calculateBMI(currentWeightKg, heightCm);

            document.getElementById('bmiDisplay').innerText = bmiResult.bmi !== 'N/A' ? bmiResult.bmi.toFixed(2) : '--';
            document.getElementById('bmiCategory').innerText = bmiResult.category;
            document.getElementById('bmiCategory').style.color = getBmiColor(bmiResult.category);
            document.getElementById('heightWeightDisplay').innerText = `الطول: ${heightCm > 0 ? heightCm + ' سم' : '--'}، الوزن: ${currentWeightKg > 0 ? currentWeightKg + ' كجم' : '--'}`;
        }

        // Save BMI history for trainee
        function addWeightEntry() {
            const heightCm = parseFloat(document.getElementById('traineeHeightCm').value);
            const currentWeightKg = parseFloat(document.getElementById('traineeCurrentWeightKg').value);

            if (heightCm <= 0 || isNaN(heightCm) || currentWeightKg <= 0 || isNaN(currentWeightKg)) {
                alert('الرجاء إدخال قيم صحيحة للطول والوزن.');
                return;
            }

            const bmiResult = calculateBMI(currentWeightKg, heightCm);
            const now = new Date();
            const dateString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            let bmiHistory = JSON.parse(localStorage.getItem('traineeBMIHistory') || '[]');
            bmiHistory.push({
                date: dateString,
                height: heightCm,
                weight: currentWeightKg,
                bmi: bmiResult.bmi,
                category: bmiResult.category
            });
            localStorage.setItem('traineeBMIHistory', JSON.stringify(bmiHistory));
            loadTraineeBMIHistory(); // Refresh the list
            alert('تم إضافة قراءة الوزن بنجاح!');
        }

        // Load BMI history and display it
        function loadTraineeBMIHistory() {
            const bmiHistoryList = document.getElementById('bmiHistoryList');
            bmiHistoryList.innerHTML = '';
            let bmiHistory = JSON.parse(localStorage.getItem('traineeBMIHistory') || '[]');

            if (bmiHistory.length === 0) {
                bmiHistoryList.innerHTML = '<li>لا توجد سجلات سابقة لمؤشر كتلة الجسم.</li>';
                return;
            }

            // Sort history by date descending
            bmiHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

            bmiHistory.forEach((entry, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>
                        تاريخ: ${entry.date}،
                        الوزن: ${entry.weight} كجم،
                        BMI: ${entry.bmi.toFixed(2)}
                        (<span style="color: ${getBmiColor(entry.category)}; font-weight: bold;">${entry.category}</span>)
                    </span>
                    <button class="remove-bmi-entry" onclick="removeBmiEntry(${index})">حذف</button>
                `;
                bmiHistoryList.appendChild(li);
            });

            // Set current height/weight inputs to the latest entry if available
            if (bmiHistory.length > 0) {
                const latestEntry = bmiHistory[0];
                document.getElementById('traineeHeightCm').value = latestEntry.height;
                document.getElementById('traineeCurrentWeightKg').value = latestEntry.weight;
                calculateAndDisplayTraineeBMI(); // Update display with latest values
            }
        }

        // Remove a BMI entry from history
        function removeBmiEntry(indexToRemove) {
            let bmiHistory = JSON.parse(localStorage.getItem('traineeBMIHistory') || '[]');
            // Re-sort before removing to ensure correct index
            bmiHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (indexToRemove >= 0 && indexToRemove < bmiHistory.length) {
                bmiHistory.splice(indexToRemove, 1);
                localStorage.setItem('traineeBMIHistory', JSON.stringify(bmiHistory));
                loadTraineeBMIHistory(); // Refresh the list
            }
        }

    </script>
</body>
</html>